# coil_spring_moderate.yaml (v2) - Moderate filter pipeline
# Created: 2025-09-21
# Last Edited: 2025-09-21
#
# Purpose:
# Moderate pipeline for coil detection with multi-timeframe confirmation.
# Adjusted parameters for current high-volatility market conditions.
#
# Pipeline Stages:
# 1. coil_1h: Detect tight coil formation on 1h timeframe
# 2. match_4h: Confirm with 4h timeframe (either coiled or turning up)
# 3. confirm_1d: Final confirmation with daily trend bias

control:
  enabled_stages: ["coil_1h", "match_4h", "confirm_1d"]  # turn any off for testing
  benchmark: false  # Set to true to disable all filters

universe:
  regex: ".*"
  exclude_symbols:
    - EUR/USDT
    - EURI/USDT
    - FDUSD/USDT
    - USD1/USDT
    - USDC/USDT
    - BUSD/USDT
    - TUSD/USDT
    - DAI/USDT

# Global feature definitions (used across all timeframes)
features:
  ema_fast: 21
  ema_mid_fast: 40
  sma_mid_slow: 50
  sma_slow: 150
  atr_window: 14
  slope_window: 100

# Stage 1: 1h Coil Detection - MODERATE PARAMETERS
coil_1h:
  price_col: close
  
  # Coil tightness criteria - ADJUSTED FOR HIGH VOLATILITY
  max_fast3_width_pct: 2.0      # EMA21–EMA40–SMA50 tightness on 1h (kept at 2.0%)
  min_bars_in_coil: 3            # consecutive bars meeting width cap (reduced from 10)
  max_tr_range_atr: 1.2          # volatility guard - INCREASED from 0.8 to 1.2
  
  # Optional: require upward micro-bias
  min_ma21_slope_pct: -0.10     # e.g., allow slightly flat/down (−0.10%)

# Stage 2: 4h Matching (either coiled or turning up) - MODERATE PARAMETERS
match_4h:
  mode: "either"                # "either" = match any of the conditions below
  
  # Option A: also coiled on 4h - LOOSER for high volatility
  max_fast3_width_pct: 6.0      # increased from 8.0 to 6.0 for tighter 4h coils
  min_bars_in_coil: 2            # reduced from 4 to 2
  
  # Option B: alignment/turn-up on 4h
  min_ma21_slope_pct: 0.0
  min_ma50_slope_pct: 0.0

# Stage 3: Daily Confirmation - MODERATE PARAMETERS
confirm_1d:
  # daily long-bias: flat-or-up baseline
  min_sma150_slope_pct: 0.0     # 0% = flat or better
  
  # optional tolerance (e.g., allow −0.15% if you want looser confirm)
  tolerance_pct: 0.0

# Output configuration
outputs:
  save_watchlists: true
  out_dir: "out"
  rules: ["1h:coil_pass", "4h:match_pass", "1d:confirm_pass"]

# Parameter Rationale:
# - max_tr_range_atr: 1.2 (increased from 0.8) - allows more volatile symbols
# - min_bars_in_coil: 3 (reduced from 10) - more flexible for current market
# - max_fast3_width_pct: 2.0 (kept) - working well, only 38 symbols fail
# - 4h parameters: slightly tightened to maintain quality while allowing more 1h passes
